apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # ì„œë¹„ìŠ¤ ì„¤ì • - Slack
  service.slack: |
    token: $slack-token

  # ë°œì†¡ ì¡°ê±´
  trigger.on-sync-succeeded: |
    - description: Application syncing has succeeded
      send:
      - app-sync-succeeded
      when: app.status.operationState.phase in ['Succeeded']
  
  ##############
  # ë©”ì‹œì§€ í…œí”Œë¦¿
  ##############

  # Sync ì„±ê³µ ë° ë©”ì‹œì§€
  template.app-sync-succeeded: |
    message: |
      âœ… *ArgoCD Sync Success*
      â€¢ App: `{{.app.metadata.name}}`
    slack:
      attachments: |
        [{
          "title": "{{.app.metadata.name}} ë™ê¸°í™” ì„±ê³µ",
          "color": "#18be52",
          "fields": [
            {
              "title": "Sync Status",
              "value": "{{.app.status.sync.status}}",
              "short": true
            },
            {
              "title": "Health Status",
              "value": "{{.app.status.health.status}}",
              "short": true
            }
          ]
        }]
  
  # Sync ì‹¤íŒ¨
  trigger.on-sync-failed: |
    - description: Application syncing has failed
      send:
      - app-sync-failed
      when: app.status.operationState.phase in ['Error', 'Failed']

  # ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ ì´ìƒ (CrashLoopBackOff ë“±)
  trigger.on-health-degraded: |
    - description: Application has degraded
      send:
      - app-health-degraded
      when: app.status.health.status == 'Degraded'

  #  Sync ì‹¤íŒ¨ ë©”ì‹œì§€
  template.app-sync-failed: |
    message: |
      ğŸš¨ *ArgoCD Sync Failed*
    slack:
      attachments: |
        [{
          "title": "âŒ {{.app.metadata.name}} ë™ê¸°í™” ì‹¤íŒ¨",
          "color": "#E01E5A",
          "fields": [
            { "title": "Error Message", "value": "{{.app.status.operationState.message}}", "short": false },
            { "title": "Repository", "value": "{{.app.spec.source.repoURL}}", "short": true }
          ]
        }]

  # ìƒíƒœ ì´ìƒ ë©”ì‹œì§€
  template.app-health-degraded: |
    message: |
      âš ï¸ *ArgoCD Health Degraded*
    slack:
      attachments: |
        [{
          "title": "âš ï¸ {{.app.metadata.name}} ìƒíƒœ ì´ìƒ (Degraded)",
          "color": "#FFCC00",
          "fields": [
            { "title": "Health Status", "value": "{{.app.status.health.status}}", "short": true },
            { "title": "Sync Status", "value": "{{.app.status.sync.status}}", "short": true }
          ]
        }]

  ##################
  # DevLake 
  ##################
      
  # DevLake Webhook ì„œë¹„ìŠ¤ ë“±ë¡
  service.webhook.devlake: |
    url: "http://devlake-ui.devlake.svc.cluster.local:4000/api/rest/plugins/webhook/connections/1/deployments"
    headers:
      - name: Authorization
        value: "Bearer $devlake-api-key"
      - name: Content-Type
        value: "application/json"

  # DevLake í˜ì´ë¡œë“œ í…œí”Œë¦¿
  template.devlake-deployment: |
    webhook:
      devlake:
        method: POST
        body: |
          {
            "id": "{{.app.metadata.name}}-{{.app.status.sync.revision}}",
            "startedDate": "{{.app.status.operationState.startedAt}}",
            "finishedDate": "{{.app.status.operationState.finishedAt}}",
            "result": "{{if eq .app.status.operationState.phase \"Succeeded\"}}SUCCESS{{else}}FAILURE{{end}}",
            "deploymentCommits": [
              {
                "repoUrl": "{{.app.spec.source.repoURL}}",
                "refName": "{{.app.spec.source.targetRevision}}",
                "startedDate": "{{.app.status.operationState.startedAt}}",
                "finishedDate": "{{.app.status.operationState.finishedAt}}",
                "commitSha": "{{.app.status.sync.revision}}"
              }
            ]
          }

  # íŠ¸ë¦¬ê±° ì„¤ì • (Sync ì™„ë£Œ ì‹œ ì „ì†¡)
  trigger.on-sync-completed-devlake: |
    - description: Send deployment data to DevLake
      send:
      - devlake-deployment
      when: app.status.operationState.phase in ['Succeeded', 'Failed', 'Error']